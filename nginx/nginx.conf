events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    upstream localmarket {
        server nextjs-app:3000;
    }

    # IMPORTANT: The n8n container MUST be named 'n8n' in the shared network
    # or you must update this hostname to match your n8n container name.
    upstream n8n_service {
        server n8n:5678;
    }

    server {
        listen 80;
        server_name localhost;

        # 1. Route for LocalMarketPWA (Root)
        location / {
            proxy_pass http://localmarket;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        # 2. Route for n8n
        # Access n8n at https://your-domain.ngrok-free.app/n8n/
        location /n8n/ {
            # Note: The trailing slash in proxy_pass is CRITICAL to strip '/n8n/' from the path
            proxy_pass http://n8n_service/; 
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;

            # Required for n8n to know its real URL
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Prefix /n8n;
        }
    }
}
